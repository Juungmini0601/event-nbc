<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë²¤íŠ¸</title>

    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        #giftBox { display: none; }
    </style>
</head>
<body>

<h1>â—ï¸â—ï¸â—ï¸â—ï¸â—ï¸10ì¡°ì˜ ì—„ì²­ë‚œ ì´ë²¤íŠ¸â—ï¸â—ï¸â—ï¸â—ï¸â—ï¸</h1>

<p>ì‹œì‘ ì‹œê°„: <span th:text="${event.startAt}"></span></p>
<p>ì¢…ë£Œ ì‹œê°„: <span th:text="${event.endAt}"></span></p>
<p>ğŸ‘€ í˜„ì¬ ì ‘ì†ì ìˆ˜: <span id="viewerCount">0</span>ëª…</p>

<div th:if="${isBeforeStart}">
    <p>â° ì•„ì§ ì´ë²¤íŠ¸ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</p>
</div>

<div th:if="${isEnded}">
    <p>ğŸ”” ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
</div>

<!-- ìˆ¨ê²¨ì§„ eventId ì €ì¥ -->
<input type="hidden" id="eventId" th:value="${event.eventId}" />

<!-- ë²„íŠ¼ (ì‹œì‘ëœ ìƒíƒœë§Œ í‘œì‹œ) -->
<div th:if="${!isBeforeStart and !isEnded}">
    <button onclick="requestGift()">ğŸ ì„ ë¬¼ ë°›ê¸°</button>
</div>

<!-- ê²°ê³¼ ë°•ìŠ¤ -->
<div id="giftBox"></div>

<script>
    const eventId = document.getElementById("eventId").value;
    const socket = new SockJS('/ws');
    const stomp = Stomp.over(socket);

    stomp.connect({}, () => {
        // 1) ì…ì¥ ì•Œë¦¼ ë³´ë‚´ê¸°
        stomp.send(`/app/enter/${eventId}`, {}, "í™”ë‘");

        // 2) ê²°ê³¼ ìˆ˜ì‹  êµ¬ë…
        stomp.subscribe(`/topic/result/${eventId}`, function (message) {
            giftBox.style.display = "block";
            const imageUrl = message.body;

            if (imageUrl === "FAILED") {
                giftBox.innerHTML = `
              <p>ğŸ˜† ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”!</p>
              <img src="https://i.namu.wiki/i/T5pSsHdoeOariQFbBYgKrxBulN1adE0fkINh3d4brcMUSpkda77l1ClV7T3bfSkWxyOM0pa2orPXflQUgc29ww.webp" width="300"/>
            `;
            } else if (imageUrl === "SOLD_OUT") {
                giftBox.innerHTML = `
              <p>ğŸ˜¢ ì„ ì°©ìˆœ ë§ˆê°! ë„ˆë¬´ ì•„ì‰¬ì›Œìš”!!</p>
              <img src="https://i.imgur.com/SDGqQQZ.gif" width="300"/>
            `;
            } else {
                giftBox.innerHTML = `
              <p>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì„ ë¬¼ì„ íšë“í–ˆìŠµë‹ˆë‹¤!</p>
              <img src="${imageUrl}" width="300"/>
            `;
            }
        });

        stomp.subscribe(`/topic/viewers/${eventId}`, function (message) {
            document.getElementById("viewerCount").innerText = message.body;
        });
    });

    function requestGift() {
        stomp.send(`/app/claim/${eventId}`, {}, "í™”ë‘"); // ë‹‰ë„¤ì„ì€ ì¼ë‹¨ "í™”ë‘"ìœ¼ë¡œ ê³ ì •
    }
</script>

</body>
</html>