<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë²¤íŠ¸</title>

    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        #giftBox { display: none; }
        #giftButton { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #giftButton:disabled { background-color: grey; cursor: not-allowed; }
        #pageBody { display: none; }

        body {
            width: 100%;
            height: 100vh;

            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            border: 1px solid black;
        }

        .container p {
            text-align: center;
            font-size: 1.5rem;
        }

        .image-container {
            display: flex;
            justify-content: center;
        }

        .button-section {
            display: flex;
            justify-content: center;
        }

    </style>
</head>
<body>

<!-- ë¡œë”© í‘œì‹œ -->
<div id="loader">
    <p>í˜ì´ì§€ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
</div>

<!-- ë³¸ë¬¸ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ìš”ì†Œ -->
<div id="pageBody">
    <div class="container">
        <h1>â—ï¸â—ï¸â—ï¸â—ï¸â—ï¸10ì¡°ì˜ ì—„ì²­ë‚œ ì´ë²¤íŠ¸â—ï¸â—ï¸â—ï¸â—ï¸â—ï¸â—ï¸</h1>

        <p>ì‹œì‘ ì‹œê°„: <span th:text="${startAt}"></span></p>
        <p>ì¢…ë£Œ ì‹œê°„: <span th:text="${endAt}"></span></p>
        <p>ğŸ‘€ í˜„ì¬ ì ‘ì†ì ìˆ˜: <span id="viewerCount">0</span>ëª…</p>
        <p>ğŸ ë‚¨ì€ ì„ ë¬¼ ê°œìˆ˜: <span id="remainingGifts">0</span>ê°œ</p>

        <div th:if="${isBeforeStart}">
            <p>â° ì•„ì§ ì´ë²¤íŠ¸ê°€ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</p>
        </div>

        <div th:if="${isEnded}">
            <p>ğŸ”” ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        </div>

        <!-- ìˆ¨ê²¨ì§„ eventId ì €ì¥ -->
        <input type="hidden" id="eventId" th:value="${event.eventId}" />

        <!-- ì„ ë¬¼ ìš”ì²­ ë²„íŠ¼ -->
        <div class="button-section">
            <button id="giftButton">ğŸ ì„ ë¬¼ ë°›ê¸° ì‹œë„</button>
        </div>


        <!-- ê²°ê³¼ ë°•ìŠ¤ -->
        <div id="giftBox"></div>
    </div>

</div>

<script>
    const eventId = document.getElementById("eventId").value;
    const socket = new SockJS('/ws');
    const stomp = Stomp.over(socket);
    const giftButton = document.getElementById("giftButton");
    const giftBox = document.getElementById("giftBox");
    let permanentlyDisabled = false;

    stomp.connect({}, () => {
        // 1) ì ‘ì†ì ìˆ˜ì™€ ë‚¨ì€ ì„ ë¬¼ ê°œìˆ˜ ìˆ˜ì‹  êµ¬ë… (ë¨¼ì € ì‹¤í–‰)
        stomp.subscribe(`/topic/viewers/${eventId}`, function (message) {
            const data = JSON.parse(message.body);
            if ('viewerCount' in data) {
                document.getElementById("viewerCount").innerText = data.viewerCount;
            }
            if ('remainingGifts' in data) {
                document.getElementById("remainingGifts").innerText = data.remainingGifts;
            }

            // ìˆ˜ì‹  ì´í›„ì— í˜ì´ì§€ í‘œì‹œ
            document.getElementById("loader").style.display = "none";
            document.getElementById("pageBody").style.display = "block";
        });

        // 2) ì ‘ì† ì•Œë¦¼ ì „ì†¡
        stomp.send(`/app/enter/${eventId}`, {}, "í™”ë‘");

        // 3) ì„ ë¬¼ ê²°ê³¼ êµ¬ë…
        stomp.subscribe(`/user/queue/result/${eventId}`, function (message) {
            giftBox.style.display = "block";
            const payload = message.body;

            // â”€â”€ ì„œë²„ê°€ "data:image/â€¦" í˜•íƒœì˜ Base64 data URLì„ ë³´ëƒˆì„ ë•Œë§Œ ì„±ê³µ ë¶„ê¸°
            if (payload.startsWith("data:image/")) {
                permanentlyDisabled = true;
                giftButton.disabled = true;
                giftBox.innerHTML = `
                    <p>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì„ ë¬¼ì„ íšë“í–ˆìŠµë‹ˆë‹¤!</p>
                    <div class="image-container">
                      <img src="${payload}" width="300"/>
                    </div>
                `;
            }
            // â”€â”€ ì‹¤íŒ¨ ì½”ë“œ ë¶„ê¸°
            else if (payload === "FAILED") {
                giftBox.innerHTML = `
                    <p>ğŸ˜† ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤! ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”!</p>
                    <div class="image-container">
                      <img src="https://i.namu.wiki/i/T5pSsHdoeOariQFbBYgKrxBulN1adE0fkINh3d4brcMUSpkda77l1ClV7T3bfSkWxyOM0pa2orPXflQUgc29ww.webp" width="300"/>
                    </div>
                `;
            }
            // â”€â”€ ì™„íŒ ì½”ë“œ ë¶„ê¸°
            else if (payload === "SOLD_OUT") {
                permanentlyDisabled = true;
                giftButton.disabled = true;
                giftBox.innerHTML = `
                    <p>ğŸ˜¢ ì„ ì°©ìˆœ ë§ˆê°! ë„ˆë¬´ ì•„ì‰¬ì›Œìš”!!</p>
                    <div class="image-container">
                      <img src="https://i.imgur.com/SDGqQQZ.gif" width="300"/>
                    </div>
                `;
            }
        });
    });

    // 4) ë²„íŠ¼ í´ë¦­ ì‹œ ì„ ë¬¼ ìš”ì²­
    giftButton.addEventListener("click", () => {
        if (permanentlyDisabled) return;

        stomp.send(`/app/claim/${eventId}`, {}, "í™”ë‘");
        giftButton.disabled = true;

        setTimeout(() => {
            if (!permanentlyDisabled) {
                giftButton.disabled = false;
                console.log('ë²„íŠ¼ í™œì„±í™” ë¡œì§ í˜¸ì¶œ')
            }
        }, 500);
    });
</script>

</body>
</html>
